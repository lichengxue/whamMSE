% Generated by roxygen2: do not edit by hand
% Please edit documentation in R/loop_through_fn.R
\name{loop_through_fn}
\alias{loop_through_fn}
\title{Perform Management Strategy Evaluation (MSE)}
\usage{
loop_through_fn(
  om,
  em_info = NULL,
  random = NULL,
  M_em = NULL,
  sel_em = NULL,
  NAA_re_em = NULL,
  move_em = NULL,
  catchability_em = NULL,
  ecov_em = NULL,
  age_comp_em = "multinomial",
  em.opt = list(separate.em = TRUE, separate.em.type = 1, do.move = FALSE, est.move =
    FALSE),
  aggregate_catch_info = NULL,
  aggregate_index_info = NULL,
  aggregate_weights_info = NULL,
  reduce_region_info = NULL,
  filter_indices = NULL,
  update_catch_info = NULL,
  update_index_info = NULL,
  user_SPR_weights_info = NULL,
  assess_years = NULL,
  assess_interval = NULL,
  base_years = NULL,
  year.use = 20,
  add.years = FALSE,
  by_fleet = TRUE,
  FXSPR_init = NULL,
  hcr = list(hcr.type = 1, hcr.opts = NULL),
  catch_alloc = list(weight_type = 1, method = "equal", user_weights = NULL, weight_years
    = 1),
  implementation_error = NULL,
  do.retro = FALSE,
  do.osa = FALSE,
  do.brps = FALSE,
  seed = 123,
  save.sdrep = FALSE,
  save.last.em = FALSE
)
}
\arguments{
\item{om}{List. The operating model containing pseudo data and simulation configurations.}

\item{em_info}{List. Information used to generate the assessment model (default = NULL).}

\item{random}{Character vector. Processes treated as random effects in the operating model (default = "log_NAA").}

\item{M_em, }{sel_em, NAA_re_em, move_em, catchability_em, ecov_em List. Configuration for natural mortality, selectivity, NAA, movement, catchability, and environmental covariates in the assessment model.}

\item{age_comp_em}{Character. Likelihood distribution for age composition data in the assessment model. Options include:
\itemize{
  \item \code{"multinomial"} (default)
  \item \code{"dir-mult"}, \code{"dirichlet-miss0"}, \code{"dirichlet-pool0"}
  \item \code{"logistic-normal-miss0"}, \code{"logistic-normal-ar1-miss0"}, \code{"logistic-normal-pool0"}
  \item \code{"logistic-normal-01-infl"}, \code{"logistic-normal-01-infl-2par"}
  \item \code{"mvtweedie"}, \code{"dir-mult-linear"}
}}

\item{em.opt}{List. EM model options.
\describe{
  \item{\code{separate.em}}{Logical. Use region-separated EMs (default = FALSE).}
  \item{\code{separate.em.type}}{Integer. Type of separation:
    \itemize{
      \item 1: Panmictic
      \item 2: Fleets-as-areas
      \item 3: Separate regional EMs
    }}
  \item{\code{do.move}, \code{est.move}}{Logical. Include/estimate movement in EM (default = FALSE).}
}}

\item{aggregate_catch_info}{List (optional). Aggregation settings for catch data:
\describe{
  \item{\code{n_fleets}}{Integer. Number of fleets.}
  \item{\code{catch_cv}}{Numeric vector. CV for each fleet.}
  \item{\code{catch_Neff}}{Numeric vector. Effective sample sizes.}
  \item{\code{use_agg_catch}}{Integer vector. 0/1 for using aggregated catch.}
  \item{\code{use_catch_paa}}{Integer vector. 0/1 for including catch PAA.}
  \item{\code{fleet_pointer}}{Integer vector. Grouping fleets for aggregation (0 = exclude).}
  \item{\code{use_catch_weighted_waa}}{Logical. Use fleet-catch-weighted WAA.}
}}

\item{aggregate_index_info}{List (optional). Aggregation settings for index data:
\describe{
  \item{\code{n_indices}}{Integer. Number of indices.}
  \item{\code{index_cv}}{Numeric vector. CV for each index.}
  \item{\code{index_Neff}}{Numeric vector. Effective sample sizes.}
  \item{\code{fracyr_indices}}{Numeric vector. Fraction of the year for each index.}
  \item{\code{q}}{Numeric vector. Initial catchability values.}
  \item{\code{use_indices}}{Integer vector. 0/1 for using the index.}
  \item{\code{use_index_paa}}{Integer vector. 0/1 for including index PAA.}
  \item{\code{units_indices}}{Integer vector. 1 = biomass, 2 = numbers.}
  \item{\code{units_index_paa}}{Integer vector. 1 = biomass, 2 = numbers.}
  \item{\code{index_pointer}}{Integer vector. Grouping indices (0 = exclude).}
  \item{\code{use_index_weighted_waa}}{Logical. Use survey-index-weighted WAA.}
}}

\item{aggregate_weights_info}{List (optional). Used to compute weighted average WAA/maturity:
\describe{
  \item{\code{ssb_waa_weights}}{List.
    \itemize{
      \item \code{fleet}: Logical. Use fleet-specific weights.
      \item \code{index}: Logical. Use index-specific weights.
      \item \code{pointer}: Integer. Points to fleet/index group to use.
    }}
  \item{\code{maturity_weights}}{List.
    \itemize{
      \item \code{fleet}: Logical.
      \item \code{index}: Logical.
      \item \code{pointer}: Integer.
    }}
}}

\item{reduce_region_info}{List (optional). Reduce regions and reassign data:
\describe{
  \item{\code{remove_regions}}{Integer vector. 0/1 flag to remove regions.}
  \item{\code{reassign}}{Numeric. Region reassignment code.}
  \item{\code{NAA_where}}{3D array (stock × region × age) indicating stock presence.}
  \item{\code{sel_em}, \code{M_em}, \code{NAA_re_em}, \code{move_em}}{EM configs for reduced regions.}
  \item{\code{onto_move_list}}{List with:
    \itemize{
      \item \code{onto_move}: 3D array (stock × region × region).
      \item \code{onto_move_pars}: 4D array (stock × region × region × 4).
      \item \code{age_mu_devs}: 4D array (stock × region × region × age).
    }}
}}

\item{filter_indices}{Integer vector (optional). 0/1 vector to exclude survey indices by region.}

\item{update_catch_info}{List (optional). Update catch CV and Neff values in the assessment model. The structure must include:
\describe{
  \item{\code{agg_catch_sigma}}{Matrix. Catch CVs (standard deviation of log catch). Can be full (\code{n_years × n_fleets}) or a subset of rows (e.g., \code{length(ind_em) × n_fleets}).}
  \item{\code{catch_Neff}}{Matrix. Effective sample sizes for catch. Must match dimensions of \code{agg_catch_sigma}.}
}}

\item{update_index_info}{List (optional). Update index CV and Neff values in the assessment model. The structure must include:
\describe{
  \item{\code{agg_index_sigma}}{Matrix. Aggregated survey index CVs. Can be full (\code{n_years × n_indices}) or a subset of rows (e.g., \code{length(ind_em) × n_indices}).}
  \item{\code{index_Neff}}{Matrix. Effective sample sizes for index data. Must match dimensions of \code{agg_index_sigma}.}
  \item{\code{remove_agg}}{Logical. Whether to remove aggregated index observations for specific pointers/years.}
  \item{\code{remove_agg_pointer}}{Integer vector. Index pointers (columns) for which aggregated index data should be removed.}
  \item{\code{remove_agg_years}}{Integer vector or matrix. Years (rows) to remove aggregated index data. If matrix, should be [years × pointers].}
  \item{\code{remove_paa}}{Logical. Whether to remove index PAA observations for specific pointers/years.}
  \item{\code{remove_paa_pointer}}{Integer vector. Index pointers (columns) for which index PAA data should be removed.}
  \item{\code{remove_paa_years}}{Integer vector or matrix. Years (rows) to remove index PAA data. If matrix, should be [years × pointers].}
}}

\item{user_SPR_weights_info}{List. Update SPR weights for calculating biological reference points in the assessment model.
\describe{
  \item{\code{method}}{Character. Specifies how weights are assigned to regions or stocks.}.
  \item{\code{weight_years}}{Integer. Number of years at the end of the time series over which to average catch or index values (default = 1).}
  \item{\code{index_pointer}}{Integer. Index number used when \code{method = "index_region"}.}
}}

\item{assess_years}{Integer vector. Assessment years.}

\item{assess_interval}{Integer. Interval (years) between assessments.}

\item{base_years}{Integer vector. Burn-in period years.}

\item{year.use}{Integer. Years used in each EM (default = 20).}

\item{add.years}{Logical. Use entire time series in EM (default = FALSE).}

\item{by_fleet}{Logical. Calculate fleet-specific F (default = TRUE).}

\item{FXSPR_init}{Numeric. Initial F for reference point calculation (optional).}

\item{hcr}{List. Harvest control rule:
\describe{
  \item{\code{hcr.type}}{Integer (1: F\_XSPR, 2: constant catch, 3: hockey stick).}
  \item{\code{hcr.opts}}{List of options including:
    \itemize{
      \item \code{use_FXSPR},
      \item \code{percentSPR}, 
      \item \code{percentFXSPR}, 
      \item \code{use_FMSY}, 
      \item \code{percentFMSY},
      \item \code{avg_yrs}, 
      \item \code{max_percent}, 
      \item \code{min_percent}, 
      \item \code{BThresh_up}, 
      \item \code{BThresh_low},
      \item \code{cont.M.re}, 
      \item \code{cont.move.re}
      }
      }
}}

\item{catch_alloc}{List. Catch allocation specifications:
\describe{
  \item{\code{weight_type}}{Integer (1–4). Weighting method.}
  \item{\code{method}}{Character. Allocation method:
    \itemize{
      \item \code{"equal"}
      \item \code{"fleet_equal"}, 
      \item \code{"fleet_region"}, 
      \item \code{"fleet_gear"}, 
      \item \code{"fleet_combined"}, 
      \item \code{"fleet_catch"},
      \item \code{"index_equal"}, 
      \item \code{"index_gear"}, 
      \item \code{"multiple_index_equal"}, 
      \item \code{"multiple_index_gear"}, 
      \item \code{"user_defined_fleets"}, 
      \item \code{"user_defined_regions"}
    }}
  \item{\code{user_weights}}{Numeric vector. User-defined weights (must sum to 1).}
  \item{\code{weight_years}}{Integer. Number of past years used to average weights.}
  \item{\code{survey_pointer}}{Integer vector. Indices used for weighting (when \code{weight_type = 3}).}
}}

\item{do.retro}{Logical. Run retrospective analysis (default = FALSE).}

\item{do.osa}{Logical. Calculate OSA residuals (default = FALSE).}

\item{do.brps}{Logical. Calculate reference points in OM (default = FALSE).}

\item{seed}{Integer. Random seed.}

\item{save.sdrep}{Logical. Save sdrep objects (default = FALSE).}

\item{save.last.em}{Logical. Save final EM (default = FALSE).}

\item{add_implementation_error}{List (optional). Adds variability to catch realization:
\describe{
  \item{\code{method}}{Character. Distribution type: \code{"lognormal"}, \code{"normal"}, \code{"uniform"}, or \code{"constant"}.}
  \item{\code{mean}}{Numeric. Mean of error distribution (log scale if lognormal).}
  \item{\code{cv}}{Numeric. Coefficient of variation (for lognormal).}
  \item{\code{sd}}{Numeric. Standard deviation (required for normal).}
  \item{\code{min}, \code{max}}{Numeric. Bounds for uniform distribution.}
  \item{\code{constant_value}}{Numeric. Fixed multiplier (used if \code{method = "constant"}).}
}}
}
\value{
List with elements:
  \describe{
    \item{\code{om}}{Updated OM.}
    \item{\code{em_list}}{List of EM results.}
    \item{\code{par.est}, \code{par.se}}{Parameter estimates and SEs.}
    \item{\code{adrep.est}, \code{adrep.se}}{ADMB report values and SEs.}
    \item{\code{opt_list}}{Optimization results.}
    \item{\code{converge_list}}{Convergence checks.}
    \item{\code{catch_advice}, \code{catch_realized}}{Advised and realized catch.}
    \item{\code{em_full}}{Full EM outputs.}
    \item{\code{em_input}}{Final EM input.}
    \item{\code{runtime}}{Elapsed time.}
    \item{\code{seed.save}}{Final random seed.}
  }
}
\description{
A wrapper function to iterate through the feedback period in a management strategy evaluation (MSE),
updating the operating model (OM), refitting the assessment model (EM), and generating catch advice.
}
\seealso{
\code{\link{make_em_input}}, \code{\link{update_om_fn}}, \code{\link{advice_fn}}
}
